name: å°è‚¡æ¯æ—¥æŠ€è¡“åˆ†æ

on:
  # æ¯å€‹äº¤æ˜“æ—¥ä¸Šåˆ 9:30 (å°ç£æ™‚é–“) = UTC 1:30
  schedule:
    - cron: '30 1 * * 1-5'  # é€±ä¸€è‡³é€±äº” UTC 1:30

  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

# è¨­å®šæ¬Šé™ä»¥ä¾¿æ¨é€åˆ° repo
permissions:
  contents: write

jobs:
  analyze-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: è¨­å®š Python ç’°å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: å®‰è£ç›¸ä¾å¥—ä»¶
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: åŸ·è¡Œè‚¡ç¥¨åˆ†æä¸¦ç”Ÿæˆå ±å‘Š
        run: |
          python generate_report.py
        env:
          TZ: Asia/Taipei

      - name: æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
        id: check_changes
        run: |
          git diff --quiet docs/index.html || echo "changed=true" >> $GITHUB_OUTPUT

      - name: æäº¤ä¸¦æ¨é€å ±å‘Š
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add docs/index.html
          git commit -m "ğŸ“Š æ›´æ–°æ¯æ—¥å°è‚¡æŠ€è¡“åˆ†æå ±å‘Š $(TZ=Asia/Taipei date +%Y-%m-%d)"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: é¡¯ç¤ºå®Œæˆè¨Šæ¯
        run: |
          echo "âœ… å°è‚¡æŠ€è¡“åˆ†æå ±å‘Šå·²æ›´æ–°"
          echo "ğŸ“… åŸ·è¡Œæ™‚é–“: $(TZ=Asia/Taipei date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ğŸ“Š å ±å‘Šä½ç½®: docs/index.html"
